worker_processes	1;

events {
    worker_connections	1024;
}

http {
    include		mime.types;
    default_type	application/octet-stream;

    sendfile		on;
    keepalive_timeout	65;

    upstream mesos {
        {% raw %}{{range service "leader.mesos"}}
        server {{.Address}}:{{.Port}};{{end}}
        {% endraw %}
    }

    upstream marathon {
        {% raw %}{{range service "marathon"}}
        server {{.Address}}:{{.Port}};{{end}}
        {% endraw %}
    }

    upstream chronos {
        {% raw %}{{range service "chronos"}}
        server {{.Address}}:{{.Port}};{{end}}
        {% endraw %}
    }

    upstream consul {
        server consul.service.{{ consul_dns_domain }}:8500;
    }

    server {
        listen 80;{% if do_mantlui_ssl|bool %}
        listen 443 default_server ssl;{% endif %}

        {% if do_mantlui_ssl|bool -%}
        ssl_certificate		/etc/nginx/ssl/nginx.cert;
        ssl_certificate_key	/etc/nginx/ssl/nginx.key;

        ssl on;
        ssl_session_cache	builtin:1000 shared:SSL:10m;
        ssl_protocols		TLSv1 TLSv1.1 TLSv1.2;
        ssl_ciphers		HIGH:!aNULL:!eNULL:!EXPORT:!CAMELLIA:!DES:!MD5:!PSK:!RC4;
        ssl_prefer_server_ciphers	on;

        error_page 497 https://$host:$server_port$request_uri;
        {% endif %}

        {% if do_mantlui_auth|bool %}
        auth_basic		on;
        auth_basic_user_file	/etc/nginx/nginx-auth.conf;
        {% endif %}

        location / {
            proxy_connect_timeout	600;
            proxy_send_timeout	600;
            proxy_read_timeout	600;
            send_timeout		600;

            root /usr/share/nginx/html;
            index index.html index.htm;
            try_files $uri $uri/ =404;
        }

        location /mesos {
            rewrite ^([^.]*[^/])$ $1/ permanent;
            proxy_pass http://mesos/;
        }

        {% raw %}{{range service "follower.mesos"}}
        location /mesos/slave/{{index (.ID | split ":") 1}} {
            proxy_set_header        Host $host;
            proxy_set_header        X-Real-IP $remote_addr;
            proxy_set_header        X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header        X-Forwarded-Proto $scheme;
            proxy_pass http://{{.Address}}:{{.Port}}/;
        }{{end}}{% endraw %}

        location /marathon/ {
            proxy_set_header        host $host;
            proxy_set_header        x-real-ip $remote_addr;
            proxy_set_header        x-forwarded-for $proxy_add_x_forwarded_for;
            proxy_set_header        x-forwarded-proto $scheme;
            proxy_pass http://marathon/;
        }

        location /chronos/ {
            proxy_set_header        host $host;
            proxy_set_header        x-real-ip $remote_addr;
            proxy_set_header        x-forwarded-for $proxy_add_x_forwarded_for;
            proxy_set_header        x-forwarded-proto $scheme;
            proxy_pass http://chronos/;
        }

        location /consul {
            root /usr/share/nginx/html;
            index index.html index.htm;
            try_files $uri $uri/ =404;
        }

        location /consul/v1 {
            rewrite /consul/(.*) /$1 break;

            proxy_set_header        host $host;
            proxy_set_header        x-real-ip $remote_addr;
            proxy_set_header        x-forwarded-for $proxy_add_x_forwarded_for;
            proxy_set_header        x-forwarded-proto $scheme;
            proxy_pass http://consul/;
        }
    }
}
